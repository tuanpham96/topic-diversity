---
title: "Variations of parameters (p_alpha, tau_max) and running SF, ER models"
subtitle: "SF via sample_pa, ER via gnp"
author: Tuan Pham 
output:
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_dir = ".", output_format = "all") })
---

```{r echo=F}
knitr::opts_chunk$set(
  echo = F, eval = T,  
  message=F, warning=F,
  fig.align = "center")
```

```{r include=F}
library(tidyverse)
library(reshape2)
library(purrr)

library(bipartite)
library(igraph)

library(pbmcapply)

source('src/topic_discovery.R')

set.seed(3327) # for reproducibility of plotting + cluster assigments 
```


```{r}
n_t <- 1000
n_a <- 200
tau_0 <- 2
setdiff_peropt <- TRUE

data_path <- 'data/params-and-models'

```



```{r}
# only run the models of the same kind 
model_generation_lists = list(
  pa_0 = partial(sample_pa,power=0.50,directed=F),
  pa_1 = partial(sample_pa,power=0.75,directed=F),
  pa_2 = partial(sample_pa,power=1.00,directed=F),
  pa_3 = partial(sample_pa,power=1.25,directed=F),
  pa_4 = partial(sample_pa,power=1.50,directed=F),
  gnp_0 = partial(sample_gnp,p=0.01,directed=F), 
  gnp_1 = partial(sample_gnp,p=0.1,directed=F), 
  gnp_2 = partial(sample_gnp,p=0.2,directed=F)
)

all_modelgens <- names(model_generation_lists)

# create parameters data frame
param_df <- expand_grid(
  p_alpha = c(0.05, 0.1, 0.3, 0.5, 0.7, 0.9, 0.95), 
  tau_max = c(100, 200, 300), 
  model_agent = all_modelgens,
  model_topic = all_modelgens,
  num_trials = 1:20
) %>% filter(model_agent == model_topic)
param_df$ind <- 1:nrow(param_df)
param_df

# save parameters 
run_params_config <- list(
  general = list(n_t = n_t, n_a = n_a, tau_0 = tau_0, setdiff_peropt = setdiff_peropt),
  params = param_df,
  models = model_generation_lists)
  
saveRDS(run_params_config, file.path(data_path, 'params.RData'))

```


```{r}
cur_data <- list.files(path = data_path, pattern = 'data.*\\.RData$') %>% c
cur_ind <- regmatches(cur_data, gregexpr("[[:digit:]]+", cur_data)) %>% as.numeric()
remainder_ind <- setdiff(param_df$ind, cur_ind)
remainder_ind
length(remainder_ind)
```

```{r}
# indlist_to_run <- remainder_ind # when interrupted or restart
indlist_to_run <- param_df$ind
```

```{r}
run_model_each <- function(comb_ind) {
  data_file_name <- file.path(data_path, sprintf('data-%06d.RData', comb_ind))
  model_gen <- list(
    agent = model_generation_lists[[param_df[comb_ind,]$model_agent]],
    topic = model_generation_lists[[param_df[comb_ind,]$model_topic]])
  td <- TopicDiscovery$new(
    n_a,
    n_t,
    param_df[comb_ind,]$p_alpha,
    tau_max = param_df[comb_ind, ]$tau_max,
    tau_0 = tau_0,
    mdl_gen = model_gen
  )
  td$update_via_matmul(show_progress = F)
  td$save_to_file(data_file_name)
}

pbmclapply(indlist_to_run, run_model_each,
           mc.cores = 6, 
           mc.set.seed = TRUE,
           mc.preschedule	= TRUE)

```



